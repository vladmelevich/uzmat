# Оптимизация производительности Uzmat

## Внесенные улучшения

### 1. Кэширование
- Добавлено кэширование для часто запрашиваемых данных
- Кэширование счетчиков просмотров (5 минут)
- Кэширование непрочитанных сообщений (30 секунд)
- Кэширование автоподнятия объявлений (5 минут)

**Для production с Redis:**
```python
# В settings.py раскомментируйте:
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}
```

### 2. Оптимизация запросов к БД
- Использование `select_related()` для ForeignKey
- Использование `prefetch_related()` для ManyToMany и обратных ForeignKey
- Использование `only()` для загрузки только нужных полей
- Использование `F()` для атомарных обновлений

### 3. Индексы базы данных
Добавлены индексы для ускорения запросов:
- `Advertisement`: индексы по is_promoted, promotion_until, user, country, city
- `ChatThread`: индексы по buyer, seller, last_message_at
- `ChatMessage`: индексы по thread, sender, created_at

**Применение индексов:**
```bash
python manage.py makemigrations
python manage.py migrate
python manage.py optimize_db  # Оптимизация SQLite
```

### 4. Оптимизация подсчета непрочитанных сообщений
- Убрана N+1 проблема
- Добавлено кэширование результатов
- Ограничение количества обрабатываемых тредов (100)

### 5. Оптимизация счетчиков просмотров
- Использование `F()` для атомарных обновлений
- Кэширование по IP для предотвращения накрутки
- Обновление через bulk операции

### 6. Автоподнятие объявлений
- Выполняется в фоне (не блокирует запрос)
- Кэширование для предотвращения частых обновлений
- Bulk update для производительности

## Рекомендации для production

### База данных
- Используйте PostgreSQL вместо SQLite
- Настройте connection pooling
- Регулярно выполняйте VACUUM и ANALYZE

### Кэширование
- Установите Redis для кэширования
- Настройте мониторинг использования памяти

### Веб-сервер
- Используйте Gunicorn с несколькими воркерами
- Настройте Nginx как reverse proxy
- Включите gzip сжатие

### Мониторинг
- Настройте логирование медленных запросов
- Используйте Django Debug Toolbar для разработки
- Мониторьте использование памяти и CPU

## Команды для оптимизации

```bash
# Создание миграций для индексов
python manage.py makemigrations

# Применение миграций
python manage.py migrate

# Оптимизация базы данных (SQLite)
python manage.py optimize_db

# Сбор статических файлов
python manage.py collectstatic --noinput
```

## Дополнительные оптимизации (опционально)

### Celery для фоновых задач
Для вынесения тяжелых операций в фон:
```bash
pip install celery redis
```

### Django Debug Toolbar
Для анализа производительности в разработке:
```bash
pip install django-debug-toolbar
```

## Метрики производительности

После оптимизации ожидаемые улучшения:
- Время загрузки главной страницы: -40-60%
- Количество запросов к БД: -50-70%
- Использование памяти: -20-30%
- Время ответа API: -30-50%


// Система интернационализации (i18n)
(function() {
  'use strict';

  // Словари переводов
  const translations = {
    ru: {
      // Общие
      'Главная': 'Главная',
      'Чаты': 'Чаты',
      'Профиль': 'Профиль',
      'Настройки': 'Настройки',
      'Выход': 'Выход',
      'Вход': 'Вход',
      'Регистрация': 'Регистрация',
      'Создать объявление': 'Создать объявление',
      'Заявки': 'Заявки',
      'Все диалоги': 'Все диалоги',
      'Диалоги': 'Диалоги',
      'Техподдержка': 'Техподдержка',
      'По объявлению': 'По объявлению',
      'Страна и язык': 'Страна и язык',
      'Выберите страну и язык для отображения': 'Выберите страну и язык для отображения',
      'Тема оформления': 'Тема оформления',
      'Светлая или темная тема': 'Светлая или темная тема',
      'Переключить': 'Переключить',
      'Казахстан': 'Казахстан',
      'Узбекистан': 'Узбекистан',
      'Россия': 'Россия',
      'Беларусь': 'Беларусь',
      'Популярные предложения': 'Популярные предложения',
      'Смотреть все': 'Смотреть все',
      'Горячие предложения': 'Горячие предложения',
      'Страна': 'Страна',
      'Город': 'Город',
      'Тип техники': 'Тип техники',
      'Марка': 'Марка',
      'Цена': 'Цена',
      'От': 'От',
      'До': 'До',
      'Все страны': 'Все страны',
      'Выберите страну': 'Выберите страну',
      'Выберите город': 'Выберите город',
      'Чтобы фильтровать по цене, сначала выберите страну.': 'Чтобы фильтровать по цене, сначала выберите страну.',
      // Главная страница
      'Аренда спецтехники': 'Аренда спецтехники',
      'бизнес-класса': 'бизнес-класса',
      'Аренда спецтехники\nбизнес-класса': 'Аренда спецтехники\nбизнес-класса',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники.': 'Единая платформа для поиска надежных подрядчиков и управления парком техники.',
      'Найти экскаватор, кран или погрузчик...': 'Найти экскаватор, кран или погрузчик...',
      'Популярные запросы:': 'Популярные запросы:',
      'Экскаватор': 'Экскаватор',
      'Погрузчик': 'Погрузчик',
      'Кран': 'Кран',
      'Бульдозер': 'Бульдозер',
      'Самосвал': 'Самосвал',
      'Манипулятор': 'Манипулятор',
      'Запчасти': 'Запчасти',
      'Ремонт': 'Ремонт',
      'Создать': 'Создать',
      'Объявления': 'Объявления',
      // Дополнительные тексты
      'Галочка': 'Галочка',
      'Галочка профиля': 'Галочка профиля',
      'Проверенный': 'Проверенный',
      'Проверенный профиль': 'Проверенный профиль',
      'Продажа спецтехники': 'Продажа спецтехники',
      'Продавец': 'Продавец',
      'На Uzmat с': 'На Uzmat с',
      'Просмотры': 'Просмотры',
      'Показать телефон': 'Показать телефон',
      'Написать сообщение': 'Написать сообщение',
      'Добавить в избранное': 'Добавить в избранное',
      'Все объявления продавца': 'Все объявления продавца',
      'Платформа': 'Платформа',
      'О компании': 'О компании',
      'О нас': 'О нас',
      'Партнерам': 'Партнерам',
      'Вакансии': 'Вакансии',
      'Поддержка': 'Поддержка',
      'Помощь': 'Помощь',
      'Правила': 'Правила',
      'Безопасность': 'Безопасность',
      'Политика конфиденциальности': 'Политика конфиденциальности',
      'Условия использования': 'Условия использования',
      'Карта сайта': 'Карта сайта',
      '© 2024 Uzmat. Все права защищены.': '© 2024 Uzmat. Все права защищены.',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники в Центральной Азии.': 'Единая платформа для поиска надежных подрядчиков и управления парком техники в Центральной Азии.',
      'Меню': 'Меню',
      'Пока нет диалогов. Открой объявление и нажми «Написать сообщение».': 'Пока нет диалогов. Открой объявление и нажми «Написать сообщение».',
    },
    uz: {
      // Общие
      'Главная': 'Bosh sahifa',
      'Чаты': 'Chatlar',
      'Профиль': 'Profil',
      'Настройки': 'Sozlamalar',
      'Выход': 'Chiqish',
      'Вход': 'Kirish',
      'Регистрация': 'Ro\'yxatdan o\'tish',
      'Создать объявление': 'E\'lon yaratish',
      'Заявки': 'Arizalar',
      'Все диалоги': 'Barcha suhbatlar',
      'Диалоги': 'Suhbatlar',
      'Техподдержка': 'Texnik yordam',
      'По объявлению': 'E\'lon bo\'yicha',
      'Страна и язык': 'Mamlakat va til',
      'Выберите страну и язык для отображения': 'Ko\'rsatish uchun mamlakat va tilni tanlang',
      'Тема оформления': 'Dizayn mavzusi',
      'Светлая или темная тема': 'Yorug\' yoki qorong\'u mavzu',
      'Переключить': 'Almashtirish',
      'Казахстан': 'Qozog\'iston',
      'Узбекистан': 'O\'zbekiston',
      'Россия': 'Rossiya',
      'Беларусь': 'Belarus',
      'Популярные предложения': 'Mashhur takliflar',
      'Смотреть все': 'Barchasini ko\'rish',
      'Горячие предложения': 'Issiq takliflar',
      'Страна': 'Mamlakat',
      'Город': 'Shahar',
      'Тип техники': 'Texnika turi',
      'Марка': 'Brend',
      'Цена': 'Narx',
      'От': 'Dan',
      'До': 'Gacha',
      'Все страны': 'Barcha mamlakatlar',
      'Выберите страну': 'Mamlakatni tanlang',
      'Выберите город': 'Shaharni tanlang',
      'Чтобы фильтровать по цене, сначала выберите страну.': 'Narx bo\'yicha filtrlash uchun avval mamlakatni tanlang.',
      // Главная страница
      'Аренда спецтехники': 'Maxsus texnika ijarasi',
      'бизнес-класса': 'biznes-klass',
      'Аренда спецтехники\nбизнес-класса': 'Maxsus texnika ijarasi\nbiznes-klass',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники.': 'Ishonchli pudratchilarni topish va texnika parkini boshqarish uchun yagona platforma.',
      'Найти экскаватор, кран или погрузчик...': 'Ekskavator, kran yoki yuk ko\'taruvchi topish...',
      'Популярные запросы:': 'Mashhur so\'rovlar:',
      'Экскаватор': 'Ekskavator',
      'Погрузчик': 'Yuk ko\'taruvchi',
      'Кран': 'Kran',
      'Бульдозер': 'Buldozer',
      'Самосвал': 'Samosval',
      'Манипулятор': 'Manipulyator',
      'Запчасти': 'Ehtiyot qismlar',
      'Ремонт': 'Ta\'mirlash',
      'Создать': 'Yaratish',
      'Объявления': 'E\'lonlar',
      // Дополнительные тексты
      'Галочка': 'Belgi',
      'Галочка профиля': 'Profil belgisi',
      'Проверенный': 'Tasdiqlangan',
      'Проверенный профиль': 'Tasdiqlangan profil',
      'Продажа спецтехники': 'Maxsus texnika sotish',
      'Продавец': 'Sotuvchi',
      'На Uzmat с': 'Uzmat da dan',
      'Просмотры': 'Ko\'rishlar',
      'Показать телефон': 'Telefonni ko\'rsatish',
      'Написать сообщение': 'Xabar yozish',
      'Добавить в избранное': 'Sevimlilarga qo\'shish',
      'Все объявления продавца': 'Sotuvchining barcha e\'lonlari',
      'Платформа': 'Platforma',
      'О компании': 'Kompaniya haqida',
      'О нас': 'Biz haqimizda',
      'Партнерам': 'Hamkorlar uchun',
      'Вакансии': 'Vakansiyalar',
      'Поддержка': 'Qo\'llab-quvvatlash',
      'Помощь': 'Yordam',
      'Правила': 'Qoidalar',
      'Безопасность': 'Xavfsizlik',
      'Политика конфиденциальности': 'Maxfiylik siyosati',
      'Условия использования': 'Foydalanish shartlari',
      'Карта сайта': 'Sayt xaritasi',
      '© 2024 Uzmat. Все права защищены.': '© 2024 Uzmat. Barcha huquqlar himoyalangan.',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники в Центральной Азии.': 'Markaziy Osiyoda ishonchli pudratchilarni topish va texnika parkini boshqarish uchun yagona platforma.',
      'Меню': 'Menyu',
      'Пока нет диалогов. Открой объявление и нажми «Написать сообщение».': 'Hozircha suhbatlar yo\'q. E\'lonni oching va «Xabar yozish» tugmasini bosing.',
    },
    kk: {
      // Общие
      'Главная': 'Басты',
      'Чаты': 'Чаттар',
      'Профиль': 'Профиль',
      'Настройки': 'Баптаулар',
      'Выход': 'Шығу',
      'Вход': 'Кіру',
      'Регистрация': 'Тіркелу',
      'Создать объявление': 'Хабарландыру жасау',
      'Заявки': 'Өтініштер',
      'Все диалоги': 'Барлық диалогтар',
      'Диалоги': 'Диалогтар',
      'Техподдержка': 'Техникалық қолдау',
      'По объявлению': 'Хабарландыру бойынша',
      'Страна и язык': 'Ел және тіл',
      'Выберите страну и язык для отображения': 'Көрсету үшін ел мен тілді таңдаңыз',
      'Тема оформления': 'Дизайн тақырыбы',
      'Светлая или темная тема': 'Жарық немесе қараңғы тақырып',
      'Переключить': 'Ауыстыру',
      'Казахстан': 'Қазақстан',
      'Узбекистан': 'Өзбекстан',
      'Россия': 'Ресей',
      'Беларусь': 'Беларусь',
      'Популярные предложения': 'Танымал ұсыныстар',
      'Смотреть все': 'Барлығын көру',
      'Горячие предложения': 'Ыстық ұсыныстар',
      'Страна': 'Ел',
      'Город': 'Қала',
      'Тип техники': 'Техника түрі',
      'Марка': 'Бренд',
      'Цена': 'Баға',
      'От': 'Басқа',
      'До': 'Дейін',
      'Все страны': 'Барлық елдер',
      'Выберите страну': 'Елді таңдаңыз',
      'Выберите город': 'Қаланы таңдаңыз',
      'Чтобы фильтровать по цене, сначала выберите страну.': 'Баға бойынша сүзгілеу үшін алдымен елді таңдаңыз.',
      // Главная страница
      'Аренда спецтехники': 'Арнайы техника жалға алу',
      'бизнес-класса': 'бизнес-класс',
      'Аренда спецтехники\nбизнес-класса': 'Арнайы техника жалға алу\nбизнес-класс',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники.': 'Сенімді подрядчиктерді табу және техника паркін басқару үшін біртұтас платформа.',
      'Найти экскаватор, кран или погрузчик...': 'Экскаватор, кран немесе жүк көтергішті табу...',
      'Популярные запросы:': 'Танымал сұраулар:',
      'Экскаватор': 'Экскаватор',
      'Погрузчик': 'Жүк көтергіш',
      'Кран': 'Кран',
      'Бульдозер': 'Бульдозер',
      'Самосвал': 'Самосвал',
      'Манипулятор': 'Манипулятор',
      'Запчасти': 'Қосалқы бөлшектер',
      'Ремонт': 'Жөндеу',
      'Создать': 'Жасау',
      'Объявления': 'Хабарландырулар',
      // Дополнительные тексты
      'Галочка': 'Белгі',
      'Галочка профиля': 'Профиль белгісі',
      'Проверенный': 'Тексерілген',
      'Проверенный профиль': 'Тексерілген профиль',
      'Продажа спецтехники': 'Арнайы техника сату',
      'Продавец': 'Сатушы',
      'На Uzmat с': 'Uzmat-та',
      'Просмотры': 'Көрулер',
      'Показать телефон': 'Телефонды көрсету',
      'Написать сообщение': 'Хабарлама жазған',
      'Добавить в избранное': 'Таңдаулыларға қосу',
      'Все объявления продавца': 'Сатушының барлық хабарландырулары',
      'Платформа': 'Платформа',
      'О компании': 'Компания туралы',
      'О нас': 'Біз туралы',
      'Партнерам': 'Серіктестерге',
      'Вакансии': 'Вакансиялар',
      'Поддержка': 'Қолдау',
      'Помощь': 'Көмек',
      'Правила': 'Ережелер',
      'Безопасность': 'Қауіпсіздік',
      'Политика конфиденциальности': 'Құпиялылық саясаты',
      'Условия использования': 'Пайдалану шарттары',
      'Карта сайта': 'Сайт картасы',
      '© 2024 Uzmat. Все права защищены.': '© 2024 Uzmat. Барлық құқықтар қорғалған.',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники в Центральной Азии.': 'Орталық Азияда сенімді подрядчиктерді табу және техника паркін басқару үшін біртұтас платформа.',
      'Меню': 'Мәзір',
      'Пока нет диалогов. Открой объявление и нажми «Написать сообщение».': 'Әлі диалогтар жоқ. Хабарландыруды ашып, «Хабарлама жазған» түймесін басыңыз.',
    },
    be: {
      // Общие
      'Главная': 'Галоўная',
      'Чаты': 'Чаты',
      'Профиль': 'Профіль',
      'Настройки': 'Налады',
      'Выход': 'Выйсці',
      'Вход': 'Уваход',
      'Регистрация': 'Рэгістрацыя',
      'Создать объявление': 'Стварыць аб\'яву',
      'Заявки': 'Заяўкі',
      'Все диалоги': 'Усе дыялогі',
      'Диалоги': 'Дыялогі',
      'Техподдержка': 'Тэхпадтрымка',
      'По объявлению': 'Па аб\'яве',
      'Страна и язык': 'Краіна і мова',
      'Выберите страну и язык для отображения': 'Выберыце краіну і мову для адлюстравання',
      'Тема оформления': 'Тэма афармлення',
      'Светлая или темная тема': 'Светлая або цёмная тэма',
      'Переключить': 'Пераключыць',
      'Казахстан': 'Казахстан',
      'Узбекистан': 'Узбекістан',
      'Россия': 'Расія',
      'Беларусь': 'Беларусь',
      'Популярные предложения': 'Папулярныя прапановы',
      'Смотреть все': 'Глядзець усё',
      'Горячие предложения': 'Гарачыя прапановы',
      'Страна': 'Краіна',
      'Город': 'Горад',
      'Тип техники': 'Тып тэхнікі',
      'Марка': 'Марка',
      'Цена': 'Цана',
      'От': 'Ад',
      'До': 'Да',
      'Все страны': 'Усе краіны',
      'Выберите страну': 'Выберыце краіну',
      'Выберите город': 'Выберыце горад',
      'Чтобы фильтровать по цене, сначала выберите страну.': 'Каб фільтраваць па цане, спачатку выберыце краіну.',
      // Главная страница
      'Аренда спецтехники': 'Аранда спецтэхнікі',
      'бизнес-класса': 'бізнес-клас',
      'Аренда спецтехники\nбизнес-класса': 'Аранда спецтэхнікі\nбізнес-клас',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники.': 'Адзіная платформа для пошуку надзейных падрадчыкаў і кіравання паркам тэхнікі.',
      'Найти экскаватор, кран или погрузчик...': 'Знайсці экскаватар, кран або пагрузчык...',
      'Популярные запросы:': 'Папулярныя запыты:',
      'Экскаватор': 'Экскаватар',
      'Погрузчик': 'Пагрузчык',
      'Кран': 'Кран',
      'Бульдозер': 'Бульдозер',
      'Самосвал': 'Самазвал',
      'Манипулятор': 'Маніпулятар',
      'Запчасти': 'Запчасткі',
      'Ремонт': 'Рэмонт',
      'Создать': 'Стварыць',
      'Объявления': 'Аб\'явы',
      // Дополнительные тексты
      'Галочка': 'Галочка',
      'Галочка профиля': 'Галочка профілю',
      'Проверенный': 'Правераны',
      'Проверенный профиль': 'Правераны профіль',
      'Продажа спецтехники': 'Продаж спецтэхнікі',
      'Продавец': 'Прадавец',
      'На Uzmat с': 'На Uzmat з',
      'Просмотры': 'Прагляды',
      'Показать телефон': 'Паказаць тэлефон',
      'Написать сообщение': 'Напісаць паведамленне',
      'Добавить в избранное': 'Дадаць у абранае',
      'Все объявления продавца': 'Усе аб\'явы прадаўца',
      'Платформа': 'Платформа',
      'О компании': 'Пра кампанію',
      'О нас': 'Пра нас',
      'Партнерам': 'Партнёрам',
      'Вакансии': 'Вакансіі',
      'Поддержка': 'Падтрымка',
      'Помощь': 'Дапамога',
      'Правила': 'Правілы',
      'Безопасность': 'Бяспека',
      'Политика конфиденциальности': 'Палітыка канфідэнцыяльнасці',
      'Условия использования': 'Умовы выкарыстання',
      'Карта сайта': 'Карта сайта',
      '© 2024 Uzmat. Все права защищены.': '© 2024 Uzmat. Усе правы абаронены.',
      'Единая платформа для поиска надежных подрядчиков и управления парком техники в Центральной Азии.': 'Адзіная платформа для пошуку надзейных падрадчыкаў і кіравання паркам тэхнікі ў Цэнтральнай Азіі.',
      'Меню': 'Меню',
      'Пока нет диалогов. Открой объявление и нажми «Написать сообщение».': 'Пакуль няма дыялогаў. Адкрыйце аб\'яву і націсніце «Напісаць паведамленне».',
    }
  };

  // Маппинг стран на языки
  const countryToLang = {
    'kz': 'kk', // Казахстан -> казахский
    'uz': 'uz', // Узбекистан -> узбекский
    'ru': 'ru', // Россия -> русский
    'by': 'be'  // Беларусь -> белорусский
  };

  // Текущий язык
  let currentLang = localStorage.getItem('i18n_lang') || 'ru';

  // Функция получения перевода
  function t(key, lang = null) {
    const langToUse = lang || currentLang;
    const dict = translations[langToUse] || translations['ru'];
    return dict[key] || key;
  }

  // Функция перевода элемента
  function translateElement(element, lang = null) {
    if (!element) return;
    
    const langToUse = lang || currentLang;
    
    // Переводим текстовые узлы
    if (element.nodeType === Node.TEXT_NODE && element.textContent.trim()) {
      const text = element.textContent.trim();
      const translated = t(text, langToUse);
      if (translated !== text) {
        element.textContent = translated;
      }
      return;
    }

    // Переводим атрибуты
    const attrsToTranslate = ['title', 'placeholder', 'aria-label'];
    attrsToTranslate.forEach(attr => {
      const value = element.getAttribute(attr);
      if (value) {
        const translated = t(value, langToUse);
        if (translated !== value) {
          element.setAttribute(attr, translated);
        }
      }
    });

    // Переводим дочерние элементы
    Array.from(element.childNodes).forEach(child => {
      if (child.nodeType === Node.ELEMENT_NODE) {
        // Пропускаем элементы с data-no-translate
        if (child.hasAttribute('data-no-translate')) {
          return;
        }
        translateElement(child, langToUse);
      } else if (child.nodeType === Node.TEXT_NODE) {
        const text = child.textContent.trim();
        if (text) {
          const translated = t(text, langToUse);
          if (translated !== text) {
            child.textContent = translated;
          }
        }
      }
    });
  }

  // Кэш для элементов, которые нужно переводить
  let translationCache = null;

  // Функция для построения кэша переводимых элементов
  function buildTranslationCache() {
    if (translationCache) return translationCache;
    
    const body = document.body;
    if (!body) return null;

    const cache = {
      elements: [],
      attributes: []
    };

    // Собираем все элементы с текстом, которые нужно переводить
    const selectors = ['a', 'button', 'span', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'label', 'p', 'li', 'td', 'th'];
    
    selectors.forEach(selector => {
      body.querySelectorAll(selector).forEach(el => {
        if (!el.hasAttribute('data-no-translate') && !el.closest('[data-no-translate]')) {
          // Получаем весь текстовый контент элемента (включая вложенные текстовые узлы)
          const text = el.textContent.trim();
          
          // Проверяем, содержит ли элемент только текст или текст с простыми тегами (br, strong, b, em, i, svg)
          const hasOnlyTextOrSimpleTags = Array.from(el.childNodes).every(node => {
            if (node.nodeType === Node.TEXT_NODE) return true;
            if (node.nodeType === Node.ELEMENT_NODE) {
              const tagName = node.tagName?.toLowerCase();
              // Разрешаем простые теги форматирования и SVG (для иконок)
              return ['br', 'strong', 'b', 'em', 'i', 'span', 'svg', 'img'].includes(tagName);
            }
            return false;
          });
          
          if (hasOnlyTextOrSimpleTags && text && text.length > 0 && text.length < 300) {
            // Сохраняем оригинальный HTML для восстановления структуры
            const originalHTML = el.innerHTML;
            cache.elements.push({ el, originalText: text, originalHTML });
          } else {
            // Для элементов только с текстом (без вложенных элементов)
            const hasOnlyText = el.childNodes.length === 1 && 
                               el.childNodes[0].nodeType === Node.TEXT_NODE;
            if (hasOnlyText) {
              if (text && text.length > 0 && text.length < 300) {
                cache.elements.push({ el, originalText: text });
              }
            } else {
              // Для элементов с несколькими текстовыми узлами (например, текст + иконка + текст)
              // Переводим каждый текстовый узел отдельно
              Array.from(el.childNodes).forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                  const nodeText = node.textContent.trim();
                  if (nodeText && nodeText.length > 0 && nodeText.length < 200) {
                    cache.elements.push({ el: node, originalText: nodeText, isTextNode: true });
                  }
                }
              });
            }
          }
        }
        
        // Собираем атрибуты для перевода
        ['title', 'placeholder', 'aria-label'].forEach(attr => {
          const value = el.getAttribute(attr);
          if (value && value.length > 0 && value.length < 300) {
            cache.attributes.push({ el, attr, originalValue: value });
          }
        });
      });
    });

    // Элементы с data-translate
    body.querySelectorAll('[data-translate]').forEach(el => {
      const key = el.getAttribute('data-translate');
      cache.elements.push({ el, originalText: key, isKey: true });
    });

    translationCache = cache;
    return cache;
  }

  // Функция перевода всей страницы (оптимизированная для мгновенного перевода)
  function translatePage(lang = null) {
    const langToUse = lang || currentLang;
    const body = document.body;
    
    if (!body) return;

    // Сбрасываем кэш при смене языка для обновления
    if (lang && lang !== currentLang) {
      translationCache = null;
    }

    const cache = buildTranslationCache();
    if (!cache) return;

    // Мгновенный синхронный перевод элементов (без задержек)
    cache.elements.forEach(({ el, originalText, isKey, originalHTML, isTextNode }) => {
      if (!el || !el.isConnected) return; // Пропускаем удаленные элементы
      
      try {
        const key = isKey ? originalText : originalText;
        const translated = t(key, langToUse);
        
        if (translated !== key && translated !== originalText) {
          // Если это текстовый узел (не элемент)
          if (isTextNode) {
            el.textContent = translated;
          }
          // Если есть originalHTML, значит элемент содержит теги (br, strong и т.д.)
          else if (originalHTML && originalHTML.includes('<')) {
            // Заменяем текстовые части, но сохраняем теги
            Array.from(el.childNodes).forEach(node => {
              if (node.nodeType === Node.TEXT_NODE) {
                const nodeText = node.textContent.trim();
                if (nodeText) {
                  const nodeTranslated = t(nodeText, langToUse);
                  if (nodeTranslated !== nodeText) {
                    node.textContent = nodeTranslated;
                  }
                }
              }
            });
          } else {
            // Простой текст - заменяем полностью
            el.textContent = translated;
          }
        }
      } catch (e) {
        // Игнорируем ошибки для производительности
      }
    });

    // Мгновенный перевод атрибутов
    cache.attributes.forEach(({ el, attr, originalValue }) => {
      if (!el || !el.isConnected) return;
      
      try {
        const translated = t(originalValue, langToUse);
        if (translated !== originalValue) {
          el.setAttribute(attr, translated);
        }
      } catch (e) {
        // Игнорируем ошибки для производительности
      }
    });
  }

  // Функция установки языка (оптимизированная для мгновенного перевода)
  function setLanguage(lang) {
    if (!translations[lang]) {
      console.warn('Language not found:', lang);
      return;
    }

    // Обновляем язык сразу
    const oldLang = currentLang;
    currentLang = lang;
    
    // Обновляем атрибут lang на html элементе МГНОВЕННО
    document.documentElement.setAttribute('lang', lang);
    
    // Сохраняем в localStorage асинхронно (не блокирует перевод)
    setTimeout(() => {
      localStorage.setItem('i18n_lang', lang);
    }, 0);
    
    // Сбрасываем кэш только если язык изменился
    if (oldLang !== lang) {
      translationCache = null;
    }
    
    // МГНОВЕННЫЙ перевод без задержек (синхронно)
    translatePage(lang);
    
    // Вызываем событие изменения языка асинхронно
    setTimeout(() => {
      document.dispatchEvent(new CustomEvent('languageChanged', { detail: { lang } }));
    }, 0);
  }

  // Функция получения языка по стране
  function getLangByCountry(country) {
    return countryToLang[country] || 'ru';
  }

  // Инициализация при загрузке
  function init() {
    // Восстанавливаем язык из localStorage
    const savedLang = localStorage.getItem('i18n_lang');
    if (savedLang && translations[savedLang]) {
      currentLang = savedLang;
      document.documentElement.setAttribute('lang', savedLang);
    }

    // Применяем переводы после загрузки DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Небольшая задержка для построения кэша после полной загрузки
        setTimeout(() => {
          buildTranslationCache();
          translatePage();
        }, 100);
      });
    } else {
      setTimeout(() => {
        buildTranslationCache();
        translatePage();
      }, 100);
    }
  }

  // Экспорт в глобальную область
  window.i18n = {
    t,
    setLanguage,
    getLanguage: () => currentLang,
    getLangByCountry,
    translatePage,
    translations
  };

  // Инициализация
  init();
})();


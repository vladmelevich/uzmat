{% load static %}
<!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω -->
<div class="uz-nav-country-selector" data-nav-country-selector>
  <button type="button" class="uz-nav-country-btn" data-nav-country-toggle>
    <span class="uz-nav-country-flag">
      <img id="nav-country-flag" src="{% static 'uzmat/kazah.svg' %}" alt="KZ" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
      <span class="uz-nav-country-flag-fallback" style="display:none;">üá∞üáø</span>
    </span>
    <span class="uz-nav-country-code">KZ</span>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>
  <div class="uz-nav-country-dropdown" data-nav-country-dropdown>
    <button type="button" class="uz-nav-country-option active" data-nav-country="kz" data-currency="‚Ç∏ KZT" data-lang="kk" data-flag="{% static 'uzmat/kazah.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/kazah.svg' %}" alt="KZ" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üá∞üáø</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</span>
        <span class="uz-nav-country-currency">‚Ç∏ KZT</span>
      </div>
    </button>
    <button type="button" class="uz-nav-country-option" data-nav-country="uz" data-currency="—Å—É–º UZS" data-lang="uz" data-flag="{% static 'uzmat/uzbek.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/uzbek.svg' %}" alt="UZ" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üá∫üáø</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</span>
        <span class="uz-nav-country-currency">—Å—É–º UZS</span>
      </div>
    </button>
    <button type="button" class="uz-nav-country-option" data-nav-country="ru" data-currency="‚ÇΩ RUB" data-lang="ru" data-flag="{% static 'uzmat/russia.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/russia.svg' %}" alt="RU" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üá∑üá∫</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–†–æ—Å—Å–∏—è</span>
        <span class="uz-nav-country-currency">‚ÇΩ RUB</span>
      </div>
    </button>
    <button type="button" class="uz-nav-country-option" data-nav-country="by" data-currency="Br BYN" data-lang="be" data-flag="{% static 'uzmat/bel.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/bel.svg' %}" alt="BY" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üáßüáæ</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–ë–µ–ª–∞—Ä—É—Å—å</span>
        <span class="uz-nav-country-currency">Br BYN</span>
      </div>
    </button>
  </div>
</div>

<script>
  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã
  function initCountrySelector() {
    const selector = document.querySelector('[data-nav-country-selector]');
    if (!selector) return;

    const toggleBtn = selector.querySelector('[data-nav-country-toggle]');
    const dropdown = selector.querySelector('[data-nav-country-dropdown]');
    const options = selector.querySelectorAll('.uz-nav-country-option');
    const flagImg = selector.querySelector('#nav-country-flag');
    const codeSpan = toggleBtn ? toggleBtn.querySelector('.uz-nav-country-code') : null;

    function closeDropdown() {
      selector.removeAttribute('data-open');
    }

    function openDropdown() {
      selector.setAttribute('data-open', 'true');
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (—Ç–æ–ª—å–∫–æ UI, –±–µ–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞)
    function restoreSelectedCountry() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä country –≤ URL
      const urlParams = new URLSearchParams(window.location.search);
      const urlCountry = urlParams.get('country');
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∞–Ω—É –∏–∑ URL –∏–ª–∏ –∏–∑ localStorage
      const savedCountry = urlCountry || localStorage.getItem('selected_country');
      
      if (savedCountry) {
        const savedOption = Array.from(options).find(opt => 
          opt.getAttribute('data-nav-country') === savedCountry
        );
        if (savedOption) {
          // –û–±–Ω–æ–≤–ª—è–µ–º UI
          options.forEach(o => o.classList.remove('active'));
          savedOption.classList.add('active');
          
          const flagSrc = savedOption.getAttribute('data-flag') || '';
          const code = savedOption.getAttribute('data-nav-country')?.toUpperCase() || '';
          
          if (flagImg && flagSrc) flagImg.src = flagSrc;
          if (codeSpan) codeSpan.textContent = code;
        }
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É —Å—Ä–∞–∑—É
    restoreSelectedCountry();

    if (toggleBtn) {
      toggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (selector.hasAttribute('data-open')) {
          closeDropdown();
        } else {
          openDropdown();
        }
      });
    }

    options.forEach(option => {
      option.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const country = option.getAttribute('data-nav-country') || '';
        const lang = option.getAttribute('data-lang') || 'ru';

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É –∏ —è–∑—ã–∫
        localStorage.setItem('selected_country', country);
        localStorage.setItem('i18n_lang', lang);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
        closeDropdown();

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π URL –∏ –¥–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä country
        const url = new URL(window.location.href);
        url.searchParams.set('country', country);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º —Å—Ç—Ä–∞–Ω—ã
        window.location.href = url.toString();
      });
    });

    document.addEventListener('click', function(e) {
      if (!selector.contains(e.target)) {
        closeDropdown();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeDropdown();
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCountrySelector);
  } else {
    // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    initCountrySelector();
  }
</script>

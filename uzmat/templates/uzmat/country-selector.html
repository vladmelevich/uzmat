{% load static %}
<!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω -->
<div class="uz-nav-country-selector" data-nav-country-selector>
  <button type="button" class="uz-nav-country-btn" data-nav-country-toggle>
    <span class="uz-nav-country-flag">
      <img id="nav-country-flag" src="{% static 'uzmat/kazah.svg' %}" alt="KZ" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
      <span class="uz-nav-country-flag-fallback" style="display:none;">üá∞üáø</span>
    </span>
    <span class="uz-nav-country-code">KZ</span>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>
  <div class="uz-nav-country-dropdown" data-nav-country-dropdown>
    <button type="button" class="uz-nav-country-option active" data-nav-country="kz" data-currency="‚Ç∏ KZT" data-lang="kk" data-flag="{% static 'uzmat/kazah.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/kazah.svg' %}" alt="KZ" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üá∞üáø</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</span>
        <span class="uz-nav-country-currency">‚Ç∏ KZT</span>
      </div>
    </button>
    <button type="button" class="uz-nav-country-option" data-nav-country="uz" data-currency="—Å—É–º UZS" data-lang="uz" data-flag="{% static 'uzmat/uzbek.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/uzbek.svg' %}" alt="UZ" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üá∫üáø</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</span>
        <span class="uz-nav-country-currency">—Å—É–º UZS</span>
      </div>
    </button>
    <button type="button" class="uz-nav-country-option" data-nav-country="ru" data-currency="‚ÇΩ RUB" data-lang="ru" data-flag="{% static 'uzmat/russia.svg' %}">
      <span class="uz-nav-country-flag">
        <img src="{% static 'uzmat/russia.svg' %}" alt="RU" class="uz-nav-country-flag-img" onerror="this.style.display='none'; if(this.nextElementSibling){this.nextElementSibling.style.display='block';}">
        <span class="uz-nav-country-flag-fallback" style="display:none;">üá∑üá∫</span>
      </span>
      <div class="uz-nav-country-info">
        <span class="uz-nav-country-name">–†–æ—Å—Å–∏—è</span>
        <span class="uz-nav-country-currency">‚ÇΩ RUB</span>
      </div>
    </button>
  </div>
</div>

<script>
  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã
  function initCountrySelector() {
    const selector = document.querySelector('[data-nav-country-selector]');
    if (!selector) return;

    const toggleBtn = selector.querySelector('[data-nav-country-toggle]');
    const dropdown = selector.querySelector('[data-nav-country-dropdown]');
    const options = selector.querySelectorAll('.uz-nav-country-option');
    const flagImg = selector.querySelector('#nav-country-flag');
    const codeSpan = toggleBtn ? toggleBtn.querySelector('.uz-nav-country-code') : null;

    function closeDropdown() {
      selector.removeAttribute('data-open');
    }

    function openDropdown() {
      selector.setAttribute('data-open', 'true');
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (—Ç–æ–ª—å–∫–æ UI, –±–µ–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞)
    function restoreSelectedCountry() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä country –≤ URL
      const urlParams = new URLSearchParams(window.location.search);
      const urlCountry = urlParams.get('country');
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∞–Ω—É –∏–∑ URL –∏–ª–∏ –∏–∑ localStorage
      const savedCountry = urlCountry || localStorage.getItem('selected_country');
      
      if (savedCountry) {
        const savedOption = Array.from(options).find(opt => 
          opt.getAttribute('data-nav-country') === savedCountry
        );
        if (savedOption) {
          // –û–±–Ω–æ–≤–ª—è–µ–º UI
          options.forEach(o => o.classList.remove('active'));
          savedOption.classList.add('active');
          
          const flagSrc = savedOption.getAttribute('data-flag') || '';
          const code = savedOption.getAttribute('data-nav-country')?.toUpperCase() || '';
          
          if (flagImg && flagSrc) flagImg.src = flagSrc;
          if (codeSpan) codeSpan.textContent = code;
        }
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É —Å—Ä–∞–∑—É
    restoreSelectedCountry();

    if (toggleBtn) {
      toggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (selector.hasAttribute('data-open')) {
          closeDropdown();
        } else {
          openDropdown();
        }
      });
    }

    options.forEach(option => {
      option.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const country = option.getAttribute('data-nav-country') || '';
        const lang = option.getAttribute('data-lang') || 'ru';

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É –∏ —è–∑—ã–∫
        localStorage.setItem('selected_country', country);
        localStorage.setItem('i18n_lang', lang);
        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä —Å—Ç—Ä–∞–Ω—ã (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ç–∞–ª–æ–≥–∞)
        localStorage.setItem('filter_country', country);

        // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
        options.forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        
        const flagSrc = option.getAttribute('data-flag') || '';
        const code = country.toUpperCase();
        
        if (flagImg && flagSrc) flagImg.src = flagSrc;
        if (codeSpan) codeSpan.textContent = code;

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        closeDropdown();

        // –ú–µ–Ω—è–µ–º —è–∑—ã–∫ –ë–ï–ó –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ i18n –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤ (–º–∞–∫—Å–∏–º—É–º 1 —Å–µ–∫—É–Ω–¥–∞)
        let attempts = 0;
        function changeLanguage() {
          if (window.i18n && window.i18n.setLanguage) {
            window.i18n.setLanguage(lang);
          } else if (attempts < 20) {
            // –ï—Å–ª–∏ i18n –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ (–º–∞–∫—Å–∏–º—É–º 20 –ø–æ–ø—ã—Ç–æ–∫)
            attempts++;
            setTimeout(changeLanguage, 50);
          }
        }
        changeLanguage();

        // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const url = new URL(window.location.href);
        url.searchParams.set('country', country);
        window.history.replaceState({}, '', url.toString());

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ DOM –≥–æ—Ç–æ–≤
        setTimeout(() => {
          updatePageFilters(country);
        }, 50);

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
        window.scrollTo(0, scrollPosition);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        setTimeout(() => {
          if (window.showToast) {
            const countryNames = {
              'kz': '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              'uz': '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω',
              'ru': '–†–æ—Å—Å–∏—è',
            };
            window.showToast(`–°—Ç—Ä–∞–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${countryNames[country] || country}`, 'success');
          }
        }, 50);
      });
    });

    document.addEventListener('click', function(e) {
      if (!selector.contains(e.target)) {
        closeDropdown();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeDropdown();
    });
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω—ã
  function updatePageFilters(country) {
    // –ò—â–µ–º —Ñ–æ—Ä–º—É —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const filterForm = document.getElementById('filters-form');
    if (!filterForm) return;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ country –≤ —Ñ–æ—Ä–º–µ
    const countryInput = filterForm.querySelector('input[name="country"]');
    if (countryInput) {
      countryInput.value = country === 'all' ? '' : country;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ
    const countrySelector = filterForm.querySelector('[data-filter-country]');
    if (countrySelector) {
      const countryDisplay = countrySelector.querySelector('[data-filter-country-display]');
      const countryOptions = countrySelector.querySelectorAll('[data-filter-name="country"]');
      
      // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
      const selectedOption = Array.from(countryOptions).find(opt => {
        const optValue = opt.getAttribute('data-filter-value');
        return optValue === country || (country === 'all' && optValue === 'all');
      });
      
      if (selectedOption && countryDisplay) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        countryDisplay.textContent = selectedOption.textContent.trim();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        countryOptions.forEach(opt => opt.classList.remove('active'));
        selectedOption.classList.add('active');
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)
    if (window.updateCityList && typeof window.updateCityList === 'function') {
      window.updateCityList(country);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ü–µ–Ω—ã (–≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º) - –í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º —ç—Ç–æ —Å—Ä–∞–∑—É –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
    const priceInputs = filterForm.querySelectorAll('input[name="price_from"], input[name="price_to"]');
    const hasCountry = country && country !== 'all' && country !== '';
    
    if (priceInputs.length > 0) {
      priceInputs.forEach(input => {
        if (hasCountry) {
          // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—è
          input.removeAttribute('disabled');
          input.disabled = false;
        } else {
          // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—è
          input.setAttribute('disabled', 'disabled');
          input.disabled = true;
          input.value = '';
        }
      });
      
      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∏–ª–∏ –¥–ª—è disabled)
      const priceContainer = filterForm.querySelector('.uz-filter-price-range');
      if (priceContainer) {
        if (hasCountry) {
          priceContainer.classList.remove('disabled');
        } else {
          priceContainer.classList.add('disabled');
        }
      }
    } else {
      // –ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏—Ö —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π —Å–µ–ª–µ–∫—Ç–æ—Ä
      const priceFrom = filterForm.querySelector('input[name="price_from"]');
      const priceTo = filterForm.querySelector('input[name="price_to"]');
      if (priceFrom) {
        if (hasCountry) {
          priceFrom.removeAttribute('disabled');
          priceFrom.disabled = false;
        } else {
          priceFrom.setAttribute('disabled', 'disabled');
          priceFrom.disabled = true;
          priceFrom.value = '';
        }
      }
      if (priceTo) {
        if (hasCountry) {
          priceTo.removeAttribute('disabled');
          priceTo.disabled = false;
        } else {
          priceTo.setAttribute('disabled', 'disabled');
          priceTo.disabled = true;
          priceTo.value = '';
        }
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ AJAX (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)
    if (window.submitFormAjax && typeof window.submitFormAjax === 'function') {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–∏—Ç—å—Å—è —Å–ø–∏—Å–∫—É –≥–æ—Ä–æ–¥–æ–≤
      setTimeout(() => {
        window.submitFormAjax();
      }, 100);
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCountrySelector);
  } else {
    // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    initCountrySelector();
  }
</script>

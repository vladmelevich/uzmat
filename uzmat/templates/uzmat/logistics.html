{% load static %}
{% load static_version %}
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–º–æ–Ω—Ç ‚Äî Uzmat</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'uzmat/logo-uzmat.svg' %}">
  {% include 'uzmat/theme-init.html' %}
  <link rel="stylesheet" href="{% static_version 'uzmat/styles.css' %}">
  <script defer src="{% static 'uzmat/app.js' %}"></script>
</head>

<body class="uz-body">

  <!-- Floating Header -->
  <header class="uz-header">
    <div class="uz-header-inner">
      <a href="{% url 'uzmat:index' %}" class="uz-logo">
        <img src="{% static 'uzmat/logo-uzmat.svg' %}" alt="Uzmat" class="uz-logo-mark">
        <span>Uzmat</span>
      </a>

      {% include 'uzmat/nav.html' %}

      <div class="uz-flex">
        {% include 'uzmat/country-selector.html' %}
        {% include 'uzmat/create-ad-button.html' %}
        <button class="uz-btn uz-btn-ghost uz-hidden-mobile" data-theme-toggle>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        {% include 'uzmat/user-avatar.html' %}
      </div>
    </div>
  </header>

  <main class="uz-container">

    <!-- Breadcrumbs -->
    <nav class="uz-breadcrumbs">
      <a href="{% url 'uzmat:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
      <span>/</span>
      <span>–†–µ–º–æ–Ω—Ç</span>
    </nav>

    <div class="uz-catalog-header">
      <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">–†–µ–º–æ–Ω—Ç</h1>
      <p style="font-size: 16px; color: var(--uz-text-dim);"><span data-translate="–ù–∞–π–¥–µ–Ω–æ:">–ù–∞–π–¥–µ–Ω–æ:</span> <strong>{{ total_count }}</strong> <span data-translate="–æ–±—ä—è–≤–ª–µ–Ω–∏–π">–æ–±—ä—è–≤–ª–µ–Ω–∏–π</span></p>
    </div>

    <!-- Filters -->
    <form method="get" action="{% url 'uzmat:logistics' %}" id="filters-form" data-catalog-url="{% url 'uzmat:logistics' %}">
      <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ad_type –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
      <input type="hidden" name="ad_type" value="service">
      
      <!-- Search Field -->
      <div class="uz-search-container" style="max-width: 600px; margin: 0 auto 32px;">
        <input type="text" class="uz-search-input" id="catalog-search-input" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è..." value="{{ request.GET.search|default:'' }}">
        <svg class="uz-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>

      <div class="uz-filters-container" style="margin-bottom: 32px;">
        <div class="uz-filters-grid">
          <!-- Country Filter -->
          <div class="uz-filter-item">
            <label class="uz-filter-label">–°—Ç—Ä–∞–Ω–∞</label>
            <div class="uz-filter-selector" data-filter-country>
              <button type="button" class="uz-filter-button" data-filter-country-toggle>
                <span data-filter-country-display>{% if request.GET.country %}{% if request.GET.country == 'kz' %}üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω{% elif request.GET.country == 'uz' %}üá∫üáø –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω{% elif request.GET.country == 'ru' %}üá∑üá∫ –†–æ—Å—Å–∏—è{% else %}–í—Å–µ —Å—Ç—Ä–∞–Ω—ã{% endif %}{% else %}–í—Å–µ —Å—Ç—Ä–∞–Ω—ã{% endif %}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="uz-filter-dropdown" data-filter-country-dropdown>
                <button type="button" class="uz-filter-option {% if not request.GET.country or request.GET.country == 'all' %}active{% endif %}" data-filter-value="all" data-filter-name="country">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</button>
                <button type="button" class="uz-filter-option {% if request.GET.country == 'kz' %}active{% endif %}" data-filter-value="kz" data-filter-name="country">
                  <span style="font-size: 18px; margin-right: 8px;">üá∞üáø</span>
                  <span>–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</span>
                </button>
                <button type="button" class="uz-filter-option {% if request.GET.country == 'uz' %}active{% endif %}" data-filter-value="uz" data-filter-name="country">
                  <span style="font-size: 18px; margin-right: 8px;">üá∫üáø</span>
                  <span>–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</span>
                </button>
                <button type="button" class="uz-filter-option {% if request.GET.country == 'ru' %}active{% endif %}" data-filter-value="ru" data-filter-name="country">
                  <span style="font-size: 18px; margin-right: 8px;">üá∑üá∫</span>
                  <span>–†–æ—Å—Å–∏—è</span>
                </button>
              </div>
              <input type="hidden" name="country" value="{{ request.GET.country|default:'' }}">
            </div>
          </div>

          <!-- City Filter -->
          <div class="uz-filter-item">
            <label class="uz-filter-label">–ì–æ—Ä–æ–¥</label>
            <div class="uz-filter-selector" data-filter-city>
              <button type="button" class="uz-filter-button" data-filter-city-toggle>
                <span data-filter-city-display>{% if request.GET.city and request.GET.city != 'all' %}{{ request.GET.city }}{% else %}–í—Å–µ –≥–æ—Ä–æ–¥–∞{% endif %}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="uz-filter-dropdown" data-filter-city-dropdown>
                <input type="text" class="uz-filter-search" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." data-filter-city-search>
                <div class="uz-filter-options-list" data-filter-city-list>
                  <button type="button" class="uz-filter-option {% if not request.GET.city or request.GET.city == 'all' %}active{% endif %}" data-filter-value="all" data-filter-name="city">–í—Å–µ –≥–æ—Ä–æ–¥–∞</button>
                  {% for city in cities %}
                  <button type="button" class="uz-filter-option {% if request.GET.city == city %}active{% endif %}" data-filter-value="{{ city }}" data-filter-name="city">{{ city }}</button>
                  {% endfor %}
                </div>
              </div>
              <input type="hidden" name="city" value="{{ request.GET.city|default:'' }}">
            </div>
          </div>

          <!-- Type Filter -->
          <div class="uz-filter-item">
            <label class="uz-filter-label">–¢–∏–ø</label>
            <input type="text" class="uz-filter-input" name="equipment_type" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä" value="{{ request.GET.equipment_type }}">
          </div>

          <!-- Brand Filter -->
          <div class="uz-filter-item">
            <label class="uz-filter-label">–ú–∞—Ä–∫–∞</label>
            <input type="text" class="uz-filter-input" name="brand" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Komatsu" value="{{ request.GET.brand }}">
          </div>

          <!-- Price Filter -->
          <div class="uz-filter-item">
            <div class="uz-filter-label-row">
              <label class="uz-filter-label">–¶–µ–Ω–∞</label>
              <button type="button" class="uz-filter-help" data-price-help-toggle aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ü–µ–Ω–µ">!</button>
              <div class="uz-filter-tooltip" data-price-help-tooltip hidden>–ß—Ç–æ–±—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É.</div>
            </div>
            <div class="uz-filter-price-range">
              <input type="number" class="uz-filter-input uz-filter-price-input" name="price_from" placeholder="–û—Ç" value="{{ request.GET.price_from }}"{% if not request.GET.country %} disabled{% endif %}>
              <span>-</span>
              <input type="number" class="uz-filter-input uz-filter-price-input" name="price_to" placeholder="–î–æ" value="{{ request.GET.price_to }}"{% if not request.GET.country %} disabled{% endif %}>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Catalog Grid -->
    <div class="uz-bento-grid">
      {% for ad in ads %}
      <article class="uz-ad-card">
        <a href="{% url 'uzmat:ad_detail' slug=ad.slug %}" class="uz-ad-card-link">
            <div class="uz-ad-image">
              {% if ad.images.exists %}
                <img src="{{ ad.images.first.image.url }}" alt="{{ ad.title }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
              {% elif ad.image %}
                <img src="{{ ad.image.url }}" alt="{{ ad.title }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
              {% else %}
              <svg class="uz-ad-image-icon" viewBox="0 0 775 775" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M209.896 678.125C290.15 678.125 355.208 613.066 355.208 532.812C355.208 452.559 290.15 387.5 209.896 387.5C129.642 387.5 64.5833 452.559 64.5833 532.812C64.5833 613.066 129.642 678.125 209.896 678.125Z" stroke="currentColor" stroke-width="48.4375" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M613.542 678.125C667.044 678.125 710.417 634.753 710.417 581.25C710.417 527.747 667.044 484.375 613.542 484.375C560.039 484.375 516.667 527.747 516.667 581.25C516.667 634.753 560.039 678.125 613.542 678.125Z" stroke="currentColor" stroke-width="48.4375" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M64.5833 339.059C101.195 311.596 144.839 295.068 190.459 291.392C236.079 287.716 281.807 297.042 322.344 318.288C362.881 339.535 396.568 371.834 419.501 411.441C442.434 451.048 453.675 496.343 451.922 542.077C451.179 561.581 450.824 571.366 455.571 576.306C460.318 581.247 469.133 581.247 486.732 581.247H516.667M419.792 290.622L520.089 309.416C595.652 323.624 633.466 330.696 655.779 357.595C678.125 384.494 678.125 423.147 678.125 500.518M645.833 387.497H613.542" stroke="currentColor" stroke-width="48.4375" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M419.792 403.646V309.58C419.792 296.943 417.973 284.565 414.334 272.445L371.354 96.875M129.167 290.625V96.875M96.875 96.875H419.792M581.25 306.771V258.333C581.25 241.205 588.054 224.778 600.166 212.666C612.278 200.554 628.705 193.75 645.833 193.75M226.042 290.625V96.875" stroke="currentColor" stroke-width="48.4375" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              {% endif %}
            </div>
            <div class="uz-ad-content">
            <div class="uz-ad-content-header">
              <div class="uz-ad-price">{{ ad.get_price_display }}</div>
              {% if user.is_authenticated %}
              <button class="uz-ad-favorite" type="button" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" data-ad-id="{{ ad.id }}" onclick="toggleFavorite(event, {{ ad.id }})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
              </button>
              {% endif %}
            </div>
            <div>
              <h3 class="uz-ad-title">{{ ad.title }}</h3>
              <p class="uz-ad-subtitle">{{ ad.get_ad_type_display }}</p>
              <p class="uz-ad-description">{{ ad.description|truncatewords:15 }}</p>
            </div>
            <div class="uz-ad-meta">
              <div class="uz-ad-meta-left">
                <svg class="uz-ad-meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span>{{ ad.city }}</span>
                <span>‚Ä¢</span>
                <span>{{ ad.created_at|date:"d M" }}</span>
              </div>
              <div class="uz-ad-meta-right">
                <svg class="uz-ad-meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span>{{ ad.views_count }}</span>
              </div>
            </div>
          </div>
        </a>
      </article>
      {% empty %}
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--uz-text-dim);">
        <p>–û–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="uz-pagination">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="uz-pagination-btn uz-pagination-btn--prev">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        –ù–∞–∑–∞–¥
      </a>
      {% else %}
      <button class="uz-pagination-btn uz-pagination-btn--prev" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        –ù–∞–∑–∞–¥
      </button>
      {% endif %}
      <div class="uz-pagination-pages">
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <button class="uz-pagination-page active">{{ num }}</button>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="uz-pagination-page">{{ num }}</a>
          {% endif %}
        {% endfor %}
      </div>
      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="uz-pagination-btn uz-pagination-btn--next">
        –í–ø–µ—Ä–µ–¥
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
      {% else %}
      <button class="uz-pagination-btn uz-pagination-btn--next" disabled>
        –í–ø–µ—Ä–µ–¥
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      {% endif %}
    </div>
    {% endif %}

  </main>

  {% include 'uzmat/footer.html' %}

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    function toggleFavorite(event, adId) {
      event.preventDefault();
      event.stopPropagation();
      
      {% if not user.is_authenticated %}
      window.location.href = "{% url 'uzmat:auth' %}";
      return;
      {% endif %}
      
      const button = event.currentTarget;
      const url = "{% url 'uzmat:toggle_favorite' ad_id=0 %}".replace('0', adId);
      const csrftoken = getCookie('csrftoken');
      
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.is_favorited !== undefined) {
          if (data.is_favorited) {
            button.style.color = 'var(--uz-primary)';
            if (button.querySelector('path')) {
              button.querySelector('path').setAttribute('fill', 'currentColor');
            }
          } else {
            button.style.color = '';
            if (button.querySelector('path')) {
              button.querySelector('path').removeAttribute('fill');
            }
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
    
    // –§–∏–ª—å—Ç—Ä—ã - –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
      const filterForm = document.getElementById('filters-form');
      if (!filterForm) return;
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ AJAX (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ä–∞–Ω–µ–µ)
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ AJAX (–¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ country-selector)
      window.submitFormAjax = function submitFormAjax() {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–æ—Ä–º—ã
        // –í–ê–ñ–ù–û: ad_type, country –∏ city –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –í–°–ï–ì–î–ê, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        const adTypeValue = formData.get('ad_type') || '';
        const countryValue = formData.get('country') || '';
        const cityValue = formData.get('city') || '';
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º ad_type –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (adTypeValue && adTypeValue.trim() !== '') {
          params.append('ad_type', adTypeValue.trim());
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º country –∏ city –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if (countryValue && countryValue.trim() !== '') {
          params.append('country', countryValue.trim());
        }
        if (cityValue && cityValue.trim() !== '') {
          params.append('city', cityValue.trim());
        }
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
        for (const [key, value] of formData.entries()) {
          if (key !== 'country' && key !== 'city' && key !== 'ad_type') {
            if (value && value.trim() !== '') {
              params.append(key, value.trim());
            }
          }
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–º–æ–Ω—Ç–∞
        let logisticsUrl = filterForm.getAttribute('data-catalog-url') || filterForm.action || '/logistics/';
        if (logisticsUrl === '' || logisticsUrl === '/') {
          logisticsUrl = '/logistics/';
        }
        logisticsUrl = logisticsUrl.split('?')[0];
        
        const fullUrl = logisticsUrl + '?' + params.toString();
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('=== –û–¢–õ–ê–î–ö–ê –§–ò–õ–¨–¢–†–û–í (–†–ï–ú–û–ù–¢) ===');
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä ad_type:', adTypeValue);
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä country:', countryValue);
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä city:', cityValue);
        console.log('–ü–æ–ª–Ω—ã–π URL –∑–∞–ø—Ä–æ—Å–∞:', fullUrl);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const adsContainer = document.querySelector('.uz-bento-grid');
        if (adsContainer) {
          const loadingDiv = document.createElement('div');
          loadingDiv.id = 'loading-indicator';
          loadingDiv.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--uz-text-dim);';
          loadingDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
          adsContainer.style.opacity = '0.5';
          adsContainer.parentNode.insertBefore(loadingDiv, adsContainer);
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
        fetch(fullUrl, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          }
        })
        .then(response => response.text())
        .then(html => {
          // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.remove();
          }
          const adsContainer = document.querySelector('.uz-bento-grid');
          if (adsContainer) {
            adsContainer.style.opacity = '1';
          }
          
          // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
          if (adsContainer) {
            const newAdsContainer = doc.querySelector('.uz-bento-grid');
            if (newAdsContainer) {
              adsContainer.innerHTML = newAdsContainer.innerHTML;
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
          const pagination = document.querySelector('.uz-pagination');
          const newPagination = doc.querySelector('.uz-pagination');
          if (pagination && newPagination) {
            pagination.outerHTML = newPagination.outerHTML;
          } else if (pagination && !newPagination) {
            pagination.remove();
          } else if (!pagination && newPagination) {
            const adsContainer = document.querySelector('.uz-bento-grid');
            if (adsContainer && adsContainer.parentNode) {
              const paginationDiv = document.createElement('div');
              paginationDiv.className = 'uz-pagination';
              paginationDiv.innerHTML = newPagination.innerHTML;
              adsContainer.parentNode.insertBefore(paginationDiv, adsContainer.nextSibling);
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—á–µ—Ç—á–∏–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
          const headerElement = document.querySelector('.uz-catalog-header h1');
          const newHeaderElement = doc.querySelector('.uz-catalog-header h1');
          if (headerElement && newHeaderElement) {
            headerElement.textContent = newHeaderElement.textContent;
          }
          
          const countElement = document.querySelector('.uz-catalog-header p');
          const newCountElement = doc.querySelector('.uz-catalog-header p');
          if (countElement && newCountElement) {
            countElement.innerHTML = newCountElement.innerHTML;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–µ –∏–∑ –Ω–æ–≤–æ–≥–æ HTML
          const newForm = doc.querySelector('#filters-form');
          if (newForm && filterForm) {
            // –û–±–Ω–æ–≤–ª—è–µ–º hidden input –¥–ª—è ad_type
            const newAdTypeInput = newForm.querySelector('input[name="ad_type"]');
            const currentAdTypeInput = filterForm.querySelector('input[name="ad_type"]');
            if (newAdTypeInput && currentAdTypeInput) {
              currentAdTypeInput.value = newAdTypeInput.value;
            } else if (newAdTypeInput && !currentAdTypeInput) {
              filterForm.insertBefore(newAdTypeInput.cloneNode(true), filterForm.firstChild);
            } else if (!newAdTypeInput && currentAdTypeInput) {
              currentAdTypeInput.remove();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º hidden inputs –¥–ª—è country –∏ city
            const newCountryInput = newForm.querySelector('input[name="country"]');
            const currentCountryInput = filterForm.querySelector('input[name="country"]');
            if (newCountryInput && currentCountryInput) {
              currentCountryInput.value = newCountryInput.value;
            }
            
            const newCityInput = newForm.querySelector('input[name="city"]');
            const currentCityInput = filterForm.querySelector('input[name="city"]');
            if (newCityInput && currentCityInput) {
              currentCityInput.value = newCityInput.value;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const newCountryDisplay = newForm.querySelector('[data-filter-country-display]');
            const currentCountryDisplay = filterForm.querySelector('[data-filter-country-display]');
            if (newCountryDisplay && currentCountryDisplay) {
              currentCountryDisplay.textContent = newCountryDisplay.textContent;
            }
            
            const newCityDisplay = newForm.querySelector('[data-filter-city-display]');
            const currentCityDisplay = filterForm.querySelector('[data-filter-city-display]');
            if (newCityDisplay && currentCityDisplay) {
              currentCityDisplay.textContent = newCityDisplay.textContent;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const newCountryOptions = newForm.querySelectorAll('[data-filter-name="country"]');
            const currentCountryOptions = filterForm.querySelectorAll('[data-filter-name="country"]');
            newCountryOptions.forEach((newOpt, index) => {
              if (currentCountryOptions[index]) {
                if (newOpt.classList.contains('active')) {
                  currentCountryOptions[index].classList.add('active');
                } else {
                  currentCountryOptions[index].classList.remove('active');
                }
              }
            });
            
            const newCityOptions = newForm.querySelectorAll('[data-filter-name="city"]');
            const currentCityOptions = filterForm.querySelectorAll('[data-filter-name="city"]');
            newCityOptions.forEach((newOpt, index) => {
              if (currentCityOptions[index]) {
                if (newOpt.classList.contains('active')) {
                  currentCityOptions[index].classList.add('active');
                } else {
                  currentCityOptions[index].classList.remove('active');
                }
              }
            });
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          window.history.pushState({}, '', fullUrl);
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
          window.scrollTo(0, scrollPosition);
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
          // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.remove();
          }
          const adsContainer = document.querySelector('.uz-bento-grid');
          if (adsContainer) {
            adsContainer.style.opacity = '1';
          }
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
      }
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
      filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitFormAjax();
        return false;
      });
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ —Å—Ç—Ä–∞–Ω—ã
      const countryToggle = filterForm.querySelector('[data-filter-country-toggle]');
      const countryDropdown = filterForm.querySelector('[data-filter-country-dropdown]');
      const countrySelector = filterForm.querySelector('[data-filter-country]');
      
      if (countryToggle && countryDropdown && countrySelector) {
        countryToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω—ã
          const citySelector = filterForm.querySelector('[data-filter-city]');
          if (citySelector) {
            citySelector.removeAttribute('data-open');
          }
          
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥—Ä–æ–ø–¥–∞—É–Ω
          if (countrySelector.hasAttribute('data-open')) {
            countrySelector.removeAttribute('data-open');
          } else {
            countrySelector.setAttribute('data-open', '');
          }
        });
      }
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –≥–æ—Ä–æ–¥–∞
      const cityToggle = filterForm.querySelector('[data-filter-city-toggle]');
      const cityDropdown = filterForm.querySelector('[data-filter-city-dropdown]');
      const citySelector = filterForm.querySelector('[data-filter-city]');
      const citySearchInput = filterForm.querySelector('[data-filter-city-search]');
      
      if (cityToggle && cityDropdown && citySelector) {
        cityToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω—ã
          if (countrySelector) {
            countrySelector.removeAttribute('data-open');
          }
          
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥—Ä–æ–ø–¥–∞—É–Ω
          if (citySelector.hasAttribute('data-open')) {
            citySelector.removeAttribute('data-open');
          } else {
            citySelector.setAttribute('data-open', '');
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (citySearchInput) {
              setTimeout(() => citySearchInput.focus(), 100);
            }
          }
        });
      }
      
      // –ü–æ–∏—Å–∫ –≤ —Ñ–∏–ª—å—Ç—Ä–µ –≥–æ—Ä–æ–¥–æ–≤
      if (citySearchInput && citySelector) {
        citySearchInput.addEventListener('input', function(e) {
          const query = e.target.value.toLowerCase().trim();
          const cityOptions = citySelector.querySelectorAll('[data-filter-name="city"]');
          
          cityOptions.forEach(option => {
            const cityName = option.textContent.toLowerCase();
            if (cityName.includes(query)) {
              option.style.display = '';
            } else {
              option.style.display = 'none';
            }
          });
        });
      }
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
      document.addEventListener('click', function(e) {
        if (!e.target.closest('[data-filter-country]') && !e.target.closest('[data-filter-city]')) {
          if (countrySelector) countrySelector.removeAttribute('data-open');
          if (citySelector) citySelector.removeAttribute('data-open');
        }
      });
      
      // –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
      const citiesByCountry = {
        kz: [
          "–ê–ª–º–∞—Ç—ã", "–ê—Å—Ç–∞–Ω–∞", "–®—ã–º–∫–µ–Ω—Ç", "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞", "–ê–∫—Ç–æ–±–µ", "–¢–∞—Ä–∞–∑", "–ü–∞–≤–ª–æ–¥–∞—Ä",
          "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫", "–°–µ–º–µ–π", "–ö–æ—Å—Ç–∞–Ω–∞–π", "–ö—ã–∑—ã–ª–æ—Ä–¥–∞", "–£—Ä–∞–ª—å—Å–∫", "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫",
          "–ê—Ç—ã—Ä–∞—É", "–¢—É—Ä–∫–µ—Å—Ç–∞–Ω", "–ö–æ–∫—à–µ—Ç–∞—É", "–¢–µ–º–∏—Ä—Ç–∞—É", "–≠–∫–∏–±–∞—Å—Ç—É–∑", "–†—É–¥–Ω—ã–π", "–ñ–∞–Ω–∞–æ–∑–µ–Ω"
        ],
        uz: [
          "–¢–∞—à–∫–µ–Ω—Ç", "–°–∞–º–∞—Ä–∫–∞–Ω–¥", "–ù–∞–º–∞–Ω–≥–∞–Ω", "–ê–Ω–¥–∏–∂–∞–Ω", "–ù—É–∫—É—Å", "–ë—É—Ö–∞—Ä–∞", "–ö–∞—Ä—à–∏",
          "–§–µ—Ä–≥–∞–Ω–∞", "–ö–æ–∫–∞–Ω–¥", "–ú–∞—Ä–≥–∏–ª–∞–Ω", "–î–∂–∏–∑–∞–∫", "–ì—É–ª–∏—Å—Ç–∞–Ω", "–¢–µ—Ä–º–µ–∑", "–£—Ä–≥–µ–Ω—á",
          "–ù–∞–≤–æ–∏", "–ê–Ω–≥—Ä–µ–Ω", "–ß–∏—Ä—á–∏–∫", "–ë–µ–∫–∞–±–∞–¥", "–î–µ–Ω–∞—É", "–®–∞—Ö—Ä–∏—Å–∞–±–∑"
        ],
        ru: [
          "–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ö–∞–∑–∞–Ω—å", "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
          "–ß–µ–ª—è–±–∏–Ω—Å–∫", "–°–∞–º–∞—Ä–∞", "–û–º—Å–∫", "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É", "–£—Ñ–∞", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫", "–í–æ—Ä–æ–Ω–µ–∂",
          "–ü–µ—Ä–º—å", "–í–æ–ª–≥–æ–≥—Ä–∞–¥", "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä", "–°–∞—Ä–∞—Ç–æ–≤", "–¢—é–º–µ–Ω—å", "–¢–æ–ª—å—è—Ç—Ç–∏", "–ò–∂–µ–≤—Å–∫"
        ]
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ (–¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ country-selector)
      window.updateCityList = function updateCityList(country) {
        const cityList = citySelector.querySelector('[data-filter-city-list]');
        if (!cityList) return;
        
        const cityHiddenInput = filterForm.querySelector('input[name="city"]');
        const cityDisplay = citySelector.querySelector('[data-filter-city-display]');
        const currentCity = cityHiddenInput ? cityHiddenInput.value : '';
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–µ
        if (country && country !== 'all' && citiesByCountry[country]) {
          const cities = citiesByCountry[country];
          // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
          if (currentCity && currentCity !== 'all' && !cities.includes(currentCity)) {
            if (cityHiddenInput) {
              cityHiddenInput.value = '';
            }
            if (cityDisplay) {
              cityDisplay.textContent = '–í—Å–µ –≥–æ—Ä–æ–¥–∞';
            }
          }
        } else if (country === 'all' || !country) {
          // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã "–í—Å–µ —Å—Ç—Ä–∞–Ω—ã", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–æ—Ä–æ–¥
          if (cityHiddenInput) {
            cityHiddenInput.value = '';
          }
          if (cityDisplay) {
            cityDisplay.textContent = '–í—Å–µ –≥–æ—Ä–æ–¥–∞';
          }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É "–í—Å–µ –≥–æ—Ä–æ–¥–∞"
        const allCitiesBtn = cityList.querySelector('[data-filter-value="all"]');
        const allCitiesHtml = allCitiesBtn ? allCitiesBtn.outerHTML : '<button type="button" class="uz-filter-option" data-filter-value="all" data-filter-name="city">–í—Å–µ –≥–æ—Ä–æ–¥–∞</button>';
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        cityList.innerHTML = allCitiesHtml;
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã
        if (country && country !== 'all' && citiesByCountry[country]) {
          const cities = citiesByCountry[country];
          cities.forEach(city => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'uz-filter-option';
            if (currentCity === city) {
              button.classList.add('active');
            }
            button.setAttribute('data-filter-value', city);
            button.setAttribute('data-filter-name', 'city');
            button.textContent = city;
            cityList.appendChild(button);
          });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ (–≤–∫–ª—é—á–∞—è "–í—Å–µ –≥–æ—Ä–æ–¥–∞")
        cityList.querySelectorAll('[data-filter-name="city"]').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const value = this.getAttribute('data-filter-value');
            const hiddenInput = filterForm.querySelector('input[name="city"]');
            if (hiddenInput) {
              hiddenInput.value = value === 'all' ? '' : value;
              // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
              const display = citySelector.querySelector('[data-filter-city-display]');
              if (display) {
                display.textContent = this.textContent.trim();
              }
              // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              cityList.querySelectorAll('[data-filter-name="city"]').forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω
              citySelector.removeAttribute('data-open');
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
              submitFormAjax();
            }
          });
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã
      filterForm.querySelectorAll('[data-filter-name="country"]').forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const value = this.getAttribute('data-filter-value');
          const hiddenInput = filterForm.querySelector('input[name="country"]');
          if (hiddenInput) {
            const countryValue = value === 'all' ? '' : value;
            hiddenInput.value = countryValue;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            const display = countrySelector.querySelector('[data-filter-country-display]');
            if (display) {
              display.textContent = this.textContent.trim();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            filterForm.querySelectorAll('[data-filter-name="country"]').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
            updateCityList(value);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ü–µ–Ω—ã (–≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º)
            const priceInputs = filterForm.querySelectorAll('input[name="price_from"], input[name="price_to"]');
            if (priceInputs.length > 0) {
              const hasCountry = value && value !== 'all' && value !== '';
              priceInputs.forEach(input => {
                if (hasCountry) {
                  // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—è
                  input.removeAttribute('disabled');
                  input.disabled = false;
                } else {
                  // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—è
                  input.setAttribute('disabled', 'disabled');
                  input.disabled = true;
                  input.value = '';
                }
              });
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω —Å—Ç—Ä–∞–Ω—ã
            countrySelector.removeAttribute('data-open');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            submitFormAjax();
          }
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
      if (citySelector) {
        const cityList = citySelector.querySelector('[data-filter-city-list]');
        if (cityList) {
          cityList.addEventListener('click', function(e) {
            const option = e.target.closest('[data-filter-name="city"]');
            if (!option) return;
            
            e.preventDefault();
            e.stopPropagation();
            const value = option.getAttribute('data-filter-value');
            const hiddenInput = filterForm.querySelector('input[name="city"]');
            if (hiddenInput) {
              hiddenInput.value = value === 'all' ? '' : value;
              // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
              const display = citySelector.querySelector('[data-filter-city-display]');
              if (display) {
                display.textContent = option.textContent.trim();
              }
              // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              cityList.querySelectorAll('[data-filter-name="city"]').forEach(btn => btn.classList.remove('active'));
              option.classList.add('active');
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω
              citySelector.removeAttribute('data-open');
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
              submitFormAjax();
            }
          });
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const currentCountry = filterForm.querySelector('input[name="country"]')?.value || '';
      if (currentCountry) {
        updateCityList(currentCountry);
      } else {
        // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –±–∞–∑—ã
        const cityList = citySelector.querySelector('[data-filter-city-list]');
        if (cityList) {
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—à–µ
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
      filterForm.querySelectorAll('input[name="equipment_type"], input[name="brand"], input[name="price_from"], input[name="price_to"]').forEach(input => {
        input.addEventListener('change', function() {
          submitFormAjax();
        });
      });
    });

    // –ü–æ–∏—Å–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–º–æ–Ω—Ç–∞
    const catalogSearchInput = document.getElementById('catalog-search-input');
    const filterForm = document.getElementById('filters-form');
    
    if (catalogSearchInput && filterForm) {
      let searchTimeout;
      let viewportMeta = document.querySelector('meta[name="viewport"]');
      let originalViewport = viewportMeta ? viewportMeta.getAttribute('content') : 'width=device-width, initial-scale=1.0';
      let isZoomed = false;

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞
      function zoomIn() {
        if (!isZoomed && viewportMeta) {
          viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.5, maximum-scale=1.5, user-scalable=no');
          isZoomed = true;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –º–∞—Å—à—Ç–∞–±–∞
      function zoomOut() {
        if (isZoomed && viewportMeta) {
          viewportMeta.setAttribute('content', originalViewport);
          isZoomed = false;
        }
      }

      // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
      catalogSearchInput.addEventListener('focus', zoomIn);
      
      catalogSearchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
        catalogSearchInput.value = query;
        
        if (!isZoomed) {
          zoomIn();
        }
        
        clearTimeout(searchTimeout);
        // –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –≤–≤–æ–¥–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –±—É–∫–≤—ã
        searchTimeout = setTimeout(() => {
          zoomOut(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
          const formData = new FormData(filterForm);
          const params = new URLSearchParams();
          
          const adTypeValue = formData.get('ad_type') || '';
          const countryValue = formData.get('country') || '';
          const cityValue = formData.get('city') || '';
          
          if (adTypeValue && adTypeValue.trim() !== '') {
            params.append('ad_type', adTypeValue.trim());
          }
          if (countryValue && countryValue.trim() !== '') {
            params.append('country', countryValue.trim());
          }
          if (cityValue && cityValue.trim() !== '') {
            params.append('city', cityValue.trim());
          }
          if (query) {
            params.append('search', query);
          }
          
          for (const [key, value] of formData.entries()) {
            if (key !== 'country' && key !== 'city' && key !== 'ad_type' && key !== 'search') {
              if (value && value.trim() !== '') {
                params.append(key, value.trim());
              }
            }
          }
          
          const logisticsUrl = filterForm.getAttribute('data-catalog-url') || filterForm.action || '/logistics/';
          const fullUrl = logisticsUrl.split('?')[0] + '?' + params.toString();
          
          fetch(fullUrl, {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            }
          })
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const adsContainer = document.querySelector('.uz-bento-grid');
            if (adsContainer) {
              const newAdsContainer = doc.querySelector('.uz-bento-grid');
              if (newAdsContainer) {
                adsContainer.innerHTML = newAdsContainer.innerHTML;
              }
            }
            
            const countElement = document.querySelector('.uz-catalog-header p');
            const newCountElement = doc.querySelector('.uz-catalog-header p');
            if (countElement && newCountElement) {
              countElement.innerHTML = newCountElement.innerHTML;
            }
            
            window.history.pushState({}, '', fullUrl);
          })
          .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
          });
        }, 300);
      });

      // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
      catalogSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          zoomOut();
          filterForm.submit();
        }
      });

      // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
      catalogSearchInput.addEventListener('blur', function() {
        setTimeout(() => {
          if (isZoomed && !catalogSearchInput.value.trim()) {
            zoomOut();
          }
        }, 200);
      });
    }
  </script>

</body>
</html>









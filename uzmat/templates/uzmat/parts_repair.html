{% load static %}
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–ø—á–∞—Å—Ç–∏ ‚Äî Uzmat</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'uzmat/logo-uzmat.svg' %}">
  {% include 'uzmat/theme-init.html' %}
  <link rel="stylesheet" href="{% static 'uzmat/styles.css' %}">
  <script defer src="{% static 'uzmat/app.js' %}"></script>
</head>

<body class="uz-body">

  <!-- Floating Header -->
  <header class="uz-header">
    <div class="uz-header-inner">
      <a href="{% url 'uzmat:index' %}" class="uz-logo">
        <img src="{% static 'uzmat/logo-uzmat.svg' %}" alt="Uzmat" class="uz-logo-mark">
        <span>Uzmat</span>
      </a>

      {% include 'uzmat/nav.html' %}

      <div class="uz-flex">
        {% include 'uzmat/country-selector.html' %}
        {% include 'uzmat/create-ad-button.html' %}
        <button class="uz-btn uz-btn-ghost uz-hidden-mobile" data-theme-toggle>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        {% include 'uzmat/user-avatar.html' %}
      </div>
    </div>
  </header>

  <main class="uz-container">

    <!-- Hero Section -->
    <section class="uz-hero uz-animate-in">
      <h1 class="uz-hero-title">
        –ó–∞–ø—á–∞—Å—Ç–∏<br>
        –¥–ª—è –≤–∞—à–µ–≥–æ –ø–∞—Ä–∫–∞
      </h1>
      <p class="uz-hero-subtitle">
        –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è —Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∏ –ø–æ –≤—Å–µ–º—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—É.
      </p>

      <div class="uz-search-container">
        <input type="text" class="uz-search-input" id="parts-search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é">
        <svg class="uz-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞ -->
      <div class="uz-search-quick-buttons">
        <span class="uz-search-quick-label">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</span>
        <div class="uz-search-quick-list">
          <button type="button" class="uz-search-quick-btn" data-search-query="–§–∏–ª—å—Ç—Ä">–§–∏–ª—å—Ç—Ä</button>
          <button type="button" class="uz-search-quick-btn" data-search-query="–ú–∞—Å–ª–æ">–ú–∞—Å–ª–æ</button>
          <button type="button" class="uz-search-quick-btn" data-search-query="–ì–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä">–ì–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä</button>
          <button type="button" class="uz-search-quick-btn" data-search-query="–¢–æ—Ä–º–æ–∑–Ω—ã–µ –∫–æ–ª–æ–¥–∫–∏">–¢–æ—Ä–º–æ–∑–Ω—ã–µ –∫–æ–ª–æ–¥–∫–∏</button>
          <button type="button" class="uz-search-quick-btn" data-search-query="–†–µ–º–µ–Ω—å">–†–µ–º–µ–Ω—å</button>
          <button type="button" class="uz-search-quick-btn" data-search-query="–®–ª–∞–Ω–≥">–®–ª–∞–Ω–≥</button>
        </div>
      </div>
    </section>

    <!-- Categories Grid -->
    <section class="uz-animate-in" style="animation-delay: 0.1s;">
      <div class="uz-flex" style="justify-content: space-between; margin-bottom: 24px; padding: 0 20px;">
        <div>
          <h2 style="font-size: 20px; font-weight: 600;">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
          <p style="font-size: 14px; color: var(--uz-text-dim); margin-top: 4px;"><span data-translate="–ù–∞–π–¥–µ–Ω–æ:">–ù–∞–π–¥–µ–Ω–æ:</span> <strong>{{ total_count }}</strong> <span data-translate="–æ–±—ä—è–≤–ª–µ–Ω–∏–π">–æ–±—ä—è–≤–ª–µ–Ω–∏–π</span></p>
        </div>
        <a href="{% url 'uzmat:catalog' %}" class="uz-btn uz-btn-ghost" style="font-size: 13px;">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ &rarr;</a>
      </div>

      <!-- Filters -->
      <form method="get" action="{% url 'uzmat:parts_repair' %}" id="filters-form">
        <input type="hidden" name="search" id="parts-search-hidden" value="{{ request.GET.search|default:'' }}">
        <div class="uz-filters-container">
          <div class="uz-filters-grid">
            <!-- Country Filter -->
            <div class="uz-filter-item">
              <label class="uz-filter-label">–°—Ç—Ä–∞–Ω–∞</label>
              <div class="uz-filter-selector" data-filter-country>
                <button type="button" class="uz-filter-button" data-filter-country-toggle>
                  <span data-filter-country-display>{% if request.GET.country %}{% if request.GET.country == 'kz' %}üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω{% elif request.GET.country == 'uz' %}üá∫üáø –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω{% elif request.GET.country == 'ru' %}üá∑üá∫ –†–æ—Å—Å–∏—è{% elif request.GET.country == 'by' %}üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å{% else %}–í—Å–µ —Å—Ç—Ä–∞–Ω—ã{% endif %}{% else %}–í—Å–µ —Å—Ç—Ä–∞–Ω—ã{% endif %}</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <div class="uz-filter-dropdown" data-filter-country-dropdown>
                  <button type="button" class="uz-filter-option {% if not request.GET.country or request.GET.country == 'all' %}active{% endif %}" data-filter-value="all" data-filter-name="country">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</button>
                  <button type="button" class="uz-filter-option {% if request.GET.country == 'kz' %}active{% endif %}" data-filter-value="kz" data-filter-name="country">
                    <span style="font-size: 18px; margin-right: 8px;">üá∞üáø</span>
                    <span>–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</span>
                  </button>
                  <button type="button" class="uz-filter-option {% if request.GET.country == 'uz' %}active{% endif %}" data-filter-value="uz" data-filter-name="country">
                    <span style="font-size: 18px; margin-right: 8px;">üá∫üáø</span>
                    <span>–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</span>
                  </button>
                  <button type="button" class="uz-filter-option {% if request.GET.country == 'ru' %}active{% endif %}" data-filter-value="ru" data-filter-name="country">
                    <span style="font-size: 18px; margin-right: 8px;">üá∑üá∫</span>
                    <span>–†–æ—Å—Å–∏—è</span>
                  </button>
                  <button type="button" class="uz-filter-option {% if request.GET.country == 'by' %}active{% endif %}" data-filter-value="by" data-filter-name="country">
                    <span style="font-size: 18px; margin-right: 8px;">üáßüáæ</span>
                    <span>–ë–µ–ª–∞—Ä—É—Å—å</span>
                  </button>
                </div>
                <input type="hidden" name="country" value="{{ request.GET.country|default:'' }}">
              </div>
            </div>

            <!-- City Filter -->
            <div class="uz-filter-item">
              <label class="uz-filter-label">–ì–æ—Ä–æ–¥</label>
              <div class="uz-filter-selector" data-filter-city>
                <button type="button" class="uz-filter-button" data-filter-city-toggle>
                  <span data-filter-city-display>{% if request.GET.city and request.GET.city != 'all' %}{{ request.GET.city }}{% else %}–í—Å–µ –≥–æ—Ä–æ–¥–∞{% endif %}</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <div class="uz-filter-dropdown" data-filter-city-dropdown>
                  <input type="text" class="uz-filter-search" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." data-filter-city-search>
                  <div class="uz-filter-options-list" data-filter-city-list>
                    <button type="button" class="uz-filter-option {% if not request.GET.city or request.GET.city == 'all' %}active{% endif %}" data-filter-value="all" data-filter-name="city">–í—Å–µ –≥–æ—Ä–æ–¥–∞</button>
                  </div>
                </div>
                <input type="hidden" name="city" value="{{ request.GET.city|default:'' }}">
              </div>
            </div>

            <!-- Type Filter -->
            <div class="uz-filter-item">
              <label class="uz-filter-label">–¢–∏–ø</label>
              <input type="text" class="uz-filter-input" name="equipment_type" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä" value="{{ request.GET.equipment_type }}">
            </div>

            <!-- Brand Filter -->
            <div class="uz-filter-item">
              <label class="uz-filter-label">–ú–∞—Ä–∫–∞</label>
              <input type="text" class="uz-filter-input" name="brand" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Komatsu" value="{{ request.GET.brand }}">
            </div>

            <!-- Price Filter -->
            <div class="uz-filter-item">
              <div class="uz-filter-label-row">
                <label class="uz-filter-label">–¶–µ–Ω–∞</label>
                <button type="button" class="uz-filter-help" data-price-help-toggle aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ü–µ–Ω–µ">!</button>
                <div class="uz-filter-tooltip" data-price-help-tooltip hidden>–ß—Ç–æ–±—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É.</div>
              </div>
              <div class="uz-filter-price-range">
                <input type="number" class="uz-filter-input uz-filter-price-input" name="price_from" placeholder="–û—Ç" value="{{ request.GET.price_from }}"{% if not request.GET.country %} disabled{% endif %}>
                <span>-</span>
                <input type="number" class="uz-filter-input uz-filter-price-input" name="price_to" placeholder="–î–æ" value="{{ request.GET.price_to }}"{% if not request.GET.country %} disabled{% endif %}>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="uz-bento-grid">
        {% for ad in ads %}
        <article class="uz-ad-card">
          <a href="{% url 'uzmat:ad_detail' slug=ad.slug %}" class="uz-ad-card-link">
            <div class="uz-ad-image">
              {% if ad.images.exists %}
                <img src="{{ ad.images.first.image.url }}" alt="{{ ad.title }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
              {% elif ad.image %}
                <img src="{{ ad.image.url }}" alt="{{ ad.title }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
              {% else %}
                <svg class="uz-ad-image-icon" viewBox="0 0 775 775" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M254.297 74.0126C253.919 74.1409 253.569 74.338 253.263 74.5938C222.4 96.1604 197.202 124.862 179.813 158.258C162.424 191.653 153.357 228.755 153.385 266.406C153.376 307.694 164.285 348.25 185.008 383.961C205.73 419.672 235.528 449.268 271.379 469.747C289.785 480.306 303.089 500.586 301.766 524.062V524.126L291.529 719.749C291.195 726.164 288.327 732.183 283.555 736.483C278.782 740.782 272.498 743.01 266.083 742.676C259.669 742.342 253.649 739.474 249.35 734.702C245.05 729.93 242.822 723.645 243.156 717.23L253.393 521.478V521.349C253.586 518.443 251.875 514.406 247.322 511.791C204.063 487.073 168.109 451.357 143.106 408.262C118.102 365.168 104.938 316.229 104.948 266.406C104.916 220.968 115.856 176.194 136.837 135.89C157.819 95.5858 188.221 60.9434 225.46 34.9074C233.442 29.1874 242.93 25.9416 252.743 25.5741C262.556 25.2067 272.26 27.7337 280.647 32.8407C296.276 42.2699 306.771 59.8043 306.771 79.9866V232.209C306.77 233.589 307.123 234.945 307.796 236.149C308.469 237.353 309.439 238.365 310.613 239.088L383.27 283.812C385.853 285.426 389.147 285.426 391.73 283.812L464.386 239.088C465.561 238.365 466.531 237.353 467.204 236.149C467.876 234.945 468.229 233.589 468.229 232.209V80.0188C468.229 59.8043 478.724 42.2699 494.385 32.8407C502.769 27.7406 512.467 25.2174 522.273 25.5848C532.079 25.9522 541.561 29.1942 549.539 34.9074C586.783 60.9465 617.188 95.5941 638.17 135.904C659.151 176.214 670.089 220.995 670.052 266.439C670.053 316.259 656.881 365.194 631.872 408.282C606.863 451.37 570.906 487.08 527.646 511.791C523.125 514.406 521.413 518.443 521.575 521.349V521.478L531.844 717.23C532.009 720.407 531.547 723.584 530.485 726.582C529.422 729.58 527.779 732.339 525.65 734.702C523.521 737.064 520.948 738.985 518.076 740.353C515.205 741.721 512.093 742.511 508.917 742.676C505.74 742.842 502.563 742.38 499.565 741.317C496.567 740.254 493.808 738.612 491.445 736.483C489.082 734.354 487.162 731.78 485.794 728.909C484.425 726.038 483.636 722.925 483.471 719.749L473.234 524.126V524.062C471.91 500.586 485.182 480.306 503.588 469.747C539.446 449.272 569.25 419.678 589.978 383.967C610.706 348.256 621.621 307.697 621.615 266.406C621.642 228.755 612.576 191.653 595.187 158.258C577.797 124.862 552.6 96.1604 521.736 74.5938C521.431 74.338 521.08 74.1409 520.703 74.0126L520.38 73.9803C520.283 73.9803 519.928 73.9803 519.379 74.3032C518.217 75.0136 516.667 76.8543 516.667 80.0188V232.177C516.667 251.811 506.495 270.023 489.768 280.292L417.111 325.016C408.206 330.494 397.956 333.395 387.5 333.395C377.044 333.395 366.794 330.494 357.888 325.016L285.232 280.324C277.018 275.271 270.234 268.199 265.526 259.783C260.818 251.367 258.342 241.886 258.333 232.242V79.9866C258.333 76.822 256.783 74.9814 255.621 74.3032C255.309 74.1304 254.971 74.0104 254.62 73.948L254.297 74.0126Z" fill="currentColor"/>
                </svg>
              {% endif %}
            </div>
            <div class="uz-ad-content">
              <div class="uz-ad-content-header">
                <div class="uz-ad-price">{{ ad.get_price_display }}</div>
                {% if user.is_authenticated %}
                <button class="uz-ad-favorite" type="button" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" data-ad-id="{{ ad.id }}" onclick="toggleFavorite(event, {{ ad.id }})">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                  </svg>
                </button>
                {% endif %}
              </div>
              <div>
                <h3 class="uz-ad-title">{{ ad.title }}</h3>
                <p class="uz-ad-subtitle">{{ ad.get_ad_type_display }}</p>
                <p class="uz-ad-description">{{ ad.description|truncatewords:12 }}</p>
              </div>
              <div class="uz-ad-meta">
                <div class="uz-ad-meta-left">
                  <span>{{ ad.city }}</span>
                  <span>‚Ä¢</span>
                  <span>{{ ad.created_at|date:"d M" }}</span>
                </div>
                <div class="uz-ad-meta-right">
                  <span>{{ ad.views_count }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                </div>
              </div>
            </div>
          </a>
        </article>
        {% empty %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--uz-text-dim);">
          <p>–û–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="uz-pagination" style="margin-top: 48px;">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="uz-pagination-btn uz-pagination-btn--prev">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        –ù–∞–∑–∞–¥
      </a>
      {% else %}
      <button class="uz-pagination-btn uz-pagination-btn--prev" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        –ù–∞–∑–∞–¥
      </button>
      {% endif %}
      <div class="uz-pagination-pages">
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <button class="uz-pagination-page active">{{ num }}</button>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="uz-pagination-page">{{ num }}</a>
          {% endif %}
        {% endfor %}
      </div>
      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="uz-pagination-btn uz-pagination-btn--next">
        –í–ø–µ—Ä–µ–¥
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
      {% else %}
      <button class="uz-pagination-btn uz-pagination-btn--next" disabled>
        –í–ø–µ—Ä–µ–¥
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      {% endif %}
    </div>
    {% endif %}

  </main>

  {% include 'uzmat/footer.html' %}

  <!-- Mobile Navigation -->
  <nav class="uz-bottom-nav uz-show-mobile">
    <a href="{% url 'uzmat:index' %}" class="uz-bottom-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="{% url 'uzmat:chats' %}" class="uz-bottom-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <span>–ß–∞—Ç—ã</span>
    </a>
    <a href="{% url 'uzmat:auth' %}" class="uz-bottom-item" style="color: var(--uz-primary);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="16"></line>
        <line x1="8" y1="12" x2="16" y2="12"></line>
      </svg>
      <span>–°–æ–∑–¥–∞—Ç—å</span>
    </a>
    <a href="{% url 'uzmat:onboarding' %}" class="uz-bottom-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
    <a href="{% url 'uzmat:settings' %}" class="uz-bottom-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path
          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
        </path>
      </svg>
      <span>–ú–µ–Ω—é</span>
    </a>
  </nav>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    function toggleFavorite(event, adId) {
      event.preventDefault();
      event.stopPropagation();
      
      {% if not user.is_authenticated %}
      window.location.href = "{% url 'uzmat:auth' %}";
      return;
      {% endif %}
      
      const button = event.currentTarget;
      const url = "{% url 'uzmat:toggle_favorite' ad_id=0 %}".replace('0', adId);
      const csrftoken = getCookie('csrftoken');
      
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.is_favorited !== undefined) {
          if (data.is_favorited) {
            button.style.color = 'var(--uz-primary)';
            if (button.querySelector('path')) {
              button.querySelector('path').setAttribute('fill', 'currentColor');
            }
          } else {
            button.style.color = '';
            if (button.querySelector('path')) {
              button.querySelector('path').removeAttribute('fill');
            }
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
    
    // –§–∏–ª—å—Ç—Ä—ã - –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
      const filterForm = document.getElementById('filters-form');
      if (!filterForm) return;
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ —Å—Ç—Ä–∞–Ω—ã
      const countryToggle = filterForm.querySelector('[data-filter-country-toggle]');
      const countryDropdown = filterForm.querySelector('[data-filter-country-dropdown]');
      const countrySelector = filterForm.querySelector('[data-filter-country]');
      
      if (countryToggle && countryDropdown && countrySelector) {
        countryToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω—ã
          const citySelector = filterForm.querySelector('[data-filter-city]');
          if (citySelector) {
            citySelector.removeAttribute('data-open');
          }
          
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥—Ä–æ–ø–¥–∞—É–Ω
          if (countrySelector.hasAttribute('data-open')) {
            countrySelector.removeAttribute('data-open');
          } else {
            countrySelector.setAttribute('data-open', '');
          }
        });
      }
      
      // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –≥–æ—Ä–æ–¥–∞
      const cityToggle = filterForm.querySelector('[data-filter-city-toggle]');
      const cityDropdown = filterForm.querySelector('[data-filter-city-dropdown]');
      const citySelector = filterForm.querySelector('[data-filter-city]');
      const citySearchInput = filterForm.querySelector('[data-filter-city-search]');
      
      if (cityToggle && cityDropdown && citySelector) {
        cityToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω—ã
          if (countrySelector) {
            countrySelector.removeAttribute('data-open');
          }
          
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥—Ä–æ–ø–¥–∞—É–Ω
          if (citySelector.hasAttribute('data-open')) {
            citySelector.removeAttribute('data-open');
          } else {
            citySelector.setAttribute('data-open', '');
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (citySearchInput) {
              setTimeout(() => citySearchInput.focus(), 100);
            }
          }
        });
      }
      
      // –ü–æ–∏—Å–∫ –≤ —Ñ–∏–ª—å—Ç—Ä–µ –≥–æ—Ä–æ–¥–æ–≤
      if (citySearchInput && citySelector) {
        citySearchInput.addEventListener('input', function(e) {
          const query = e.target.value.toLowerCase().trim();
          const cityOptions = citySelector.querySelectorAll('[data-filter-name="city"]');
          
          cityOptions.forEach(option => {
            const cityName = option.textContent.toLowerCase();
            if (cityName.includes(query)) {
              option.style.display = '';
            } else {
              option.style.display = 'none';
            }
          });
        });
      }
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
      document.addEventListener('click', function(e) {
        if (!e.target.closest('[data-filter-country]') && !e.target.closest('[data-filter-city]')) {
          if (countrySelector) countrySelector.removeAttribute('data-open');
          if (citySelector) citySelector.removeAttribute('data-open');
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã
      filterForm.querySelectorAll('[data-filter-name="country"]').forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const value = this.getAttribute('data-filter-value');
          const hiddenInput = filterForm.querySelector('input[name="country"]');
          if (hiddenInput) {
            hiddenInput.value = value === 'all' ? '' : value;
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            const display = countrySelector.querySelector('[data-filter-country-display]');
            if (display) {
              display.textContent = this.textContent.trim();
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω
            countrySelector.removeAttribute('data-open');
            filterForm.submit();
          }
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
      filterForm.querySelectorAll('[data-filter-name="city"]').forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const value = this.getAttribute('data-filter-value');
          const hiddenInput = filterForm.querySelector('input[name="city"]');
          if (hiddenInput) {
            hiddenInput.value = value === 'all' ? '' : value;
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            const display = citySelector.querySelector('[data-filter-city-display]');
            if (display) {
              display.textContent = this.textContent.trim();
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω
            citySelector.removeAttribute('data-open');
            filterForm.submit();
          }
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
      filterForm.querySelectorAll('input[name="equipment_type"], input[name="brand"], input[name="price_from"], input[name="price_to"]').forEach(input => {
        input.addEventListener('change', function() {
          filterForm.submit();
        });
      });
    });

    // –ü–æ–∏—Å–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–ø—á–∞—Å—Ç–µ–π
    const partsSearchInput = document.getElementById('parts-search-input');
    const partsSearchHidden = document.getElementById('parts-search-hidden');
    const filterForm = document.getElementById('filters-form');
    
    if (partsSearchInput && filterForm && partsSearchHidden) {
      let searchTimeout;
      let viewportMeta = document.querySelector('meta[name="viewport"]');
      let originalViewport = viewportMeta ? viewportMeta.getAttribute('content') : 'width=device-width, initial-scale=1.0';
      let isZoomed = false;

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞
      function zoomIn() {
        if (!isZoomed && viewportMeta) {
          viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.5, maximum-scale=1.5, user-scalable=no');
          isZoomed = true;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –º–∞—Å—à—Ç–∞–±–∞
      function zoomOut() {
        if (isZoomed && viewportMeta) {
          viewportMeta.setAttribute('content', originalViewport);
          isZoomed = false;
        }
      }

      // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
      partsSearchInput.addEventListener('focus', zoomIn);
      
      partsSearchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –æ–±–æ–∏—Ö –ø–æ–ª—è—Ö
        partsSearchInput.value = query;
        partsSearchHidden.value = query;
        
        if (!isZoomed) {
          zoomIn();
        }
        
        clearTimeout(searchTimeout);
        // –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –≤–≤–æ–¥–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –±—É–∫–≤—ã
        searchTimeout = setTimeout(() => {
          zoomOut(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º search (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ –¥–ª—è —Å–±—Ä–æ—Å–∞)
          filterForm.submit();
        }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300ms –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
      });

      // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
      partsSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          zoomOut();
          filterForm.submit();
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Backspace –∏ Delete –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
      partsSearchInput.addEventListener('keydown', function(e) {
        if ((e.key === 'Backspace' || e.key === 'Delete') && this.value.length === 1) {
          clearTimeout(searchTimeout);
          const emptyValue = '';
          this.value = emptyValue;
          partsSearchHidden.value = emptyValue;
          zoomOut();
          searchTimeout = setTimeout(() => {
            filterForm.submit();
          }, 100);
        }
      });

      // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
      partsSearchInput.addEventListener('blur', function() {
        setTimeout(() => {
          if (isZoomed && !partsSearchInput.value.trim()) {
            zoomOut();
          }
        }, 200);
      });
    }

    // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–ø—á–∞—Å—Ç–µ–π
    document.querySelectorAll('.uz-search-quick-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const query = this.getAttribute('data-search-query');
        if (query && partsSearchInput) {
          partsSearchInput.value = query;
          if (partsSearchHidden) {
            partsSearchHidden.value = query;
          }
          if (filterForm) {
            filterForm.submit();
          }
        }
      });
    });
  </script>

</body>

</html>